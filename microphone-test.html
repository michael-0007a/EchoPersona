<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Microphone Test & Fix</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 { color: #333; }
        button {
            padding: 15px 30px;
            margin: 10px 5px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .start-btn {
            background: #4CAF50;
            color: white;
        }
        .start-btn:hover { background: #45a049; }
        .stop-btn {
            background: #f44336;
            color: white;
        }
        .stop-btn:hover { background: #da190b; }
        .test-btn {
            background: #2196F3;
            color: white;
        }
        .test-btn:hover { background: #0b7dda; }
        .status {
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            display: none;
        }
        .status.info { background: #e3f2fd; border-left: 4px solid #2196F3; }
        .status.success { background: #e8f5e9; border-left: 4px solid #4CAF50; }
        .status.error { background: #ffebee; border-left: 4px solid #f44336; }
        .status.warning { background: #fff3e0; border-left: 4px solid #ff9800; }
        #log {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            margin-top: 20px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 3px 0;
        }
        .log-info { color: #2196F3; }
        .log-success { color: #4CAF50; }
        .log-error { color: #f44336; }
        .log-warning { color: #ff9800; }
        #audioInfo {
            margin: 20px 0;
            padding: 15px;
            background: #f9f9f9;
            border-radius: 5px;
        }
        .recording-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            background: red;
            border-radius: 50%;
            margin-left: 10px;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé§ Microphone Test & Diagnostic Tool</h1>
        <p>This tool will help you fix your microphone recording issues.</p>

        <div id="statusInfo" class="status info"></div>
        <div id="statusSuccess" class="status success"></div>
        <div id="statusError" class="status error"></div>
        <div id="statusWarning" class="status warning"></div>

        <div style="margin: 30px 0;">
            <button id="testMic" class="test-btn">Test Microphone Access</button>
            <button id="startRecording" class="start-btn" disabled>Start Recording</button>
            <button id="stopRecording" class="stop-btn" disabled>Stop Recording</button>
            <button id="testSpeech" class="test-btn" style="display: none;">Test Speech Recognition</button>
            <span id="recordingIndicator" style="display: none;">
                <span class="recording-indicator"></span> Recording...
            </span>
        </div>

        <div id="audioInfo"></div>
        <div id="speechResult" style="margin: 20px 0; padding: 15px; background: #f0f8ff; border-radius: 5px; display: none;">
            <strong>üéØ Speech Recognition Result:</strong>
            <div id="speechText" style="margin-top: 10px; font-size: 18px; color: #333;"></div>
            <div id="responseText" style="margin-top: 10px; padding: 10px; background: #e8f5e9; border-radius: 5px;"></div>
            <audio id="responseAudio" controls style="width: 100%; margin-top: 10px; display: none;"></audio>
        </div>

        <h3>Console Log:</h3>
        <div id="log"></div>
    </div>

    <script>
        let mediaRecorder;
        let audioChunks = [];
        let stream;
        let lastRecordedBlob = null;  // Store the last recording
        const API_URL = 'http://localhost:8000';

        // Logging function
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }

        // Status display
        function showStatus(message, type = 'info') {
            // Hide all status divs
            ['info', 'success', 'error', 'warning'].forEach(t => {
                const el = document.getElementById(`status${t.charAt(0).toUpperCase() + t.slice(1)}`);
                el.style.display = 'none';
            });

            // Show the relevant one
            const statusDiv = document.getElementById(`status${type.charAt(0).toUpperCase() + type.slice(1)}`);
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
        }

        // Test microphone access
        document.getElementById('testMic').addEventListener('click', async () => {
            log('üé§ Testing microphone access...', 'info');
            showStatus('Requesting microphone permission...', 'info');

            try {
                // Request microphone with enhanced constraints - MATCH ChatInterface settings
                stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true,
                        sampleRate: 48000,  // Match ChatInterface - use browser default
                        channelCount: 1
                    }
                });

                log('‚úÖ Microphone access granted!', 'success');

                const audioTracks = stream.getAudioTracks();
                if (audioTracks.length > 0) {
                    const track = audioTracks[0];
                    const settings = track.getSettings();

                    let info = `<strong>‚úÖ Microphone Connected:</strong><br>`;
                    info += `Device: ${track.label}<br>`;
                    info += `Sample Rate: ${settings.sampleRate} Hz<br>`;
                    info += `Channels: ${settings.channelCount}<br>`;
                    info += `Status: ${track.readyState}<br>`;

                    document.getElementById('audioInfo').innerHTML = info;
                    log(`Microphone: ${track.label}`, 'success');
                    log(`Settings: ${JSON.stringify(settings)}`, 'info');

                    showStatus('‚úÖ Microphone is working! You can now start recording.', 'success');
                    document.getElementById('startRecording').disabled = false;
                }

                // Check supported MIME types
                const mimeTypes = [
                    'audio/webm;codecs=opus',
                    'audio/webm',
                    'audio/ogg;codecs=opus',
                    'audio/mp4'
                ];

                log('Checking supported formats:', 'info');
                mimeTypes.forEach(type => {
                    if (MediaRecorder.isTypeSupported(type)) {
                        log(`  ‚úÖ ${type}`, 'success');
                    } else {
                        log(`  ‚ùå ${type}`, 'error');
                    }
                });

            } catch (error) {
                log(`‚ùå Microphone access failed: ${error.message}`, 'error');
                showStatus(`‚ùå Error: ${error.message}. Please check browser permissions.`, 'error');
                document.getElementById('audioInfo').innerHTML = `
                    <strong>‚ö†Ô∏è Troubleshooting:</strong><br>
                    1. Click the üîí or ‚ìò icon in your browser's address bar<br>
                    2. Enable microphone permissions for this site<br>
                    3. Refresh the page and try again<br>
                    4. Make sure your microphone is not being used by another app
                `;
            }
        });

        // Start recording
        document.getElementById('startRecording').addEventListener('click', async () => {
            if (!stream) {
                showStatus('‚ùå Please test microphone first!', 'error');
                return;
            }

            try {
                audioChunks = [];

                // Find best supported MIME type
                let mimeType = 'audio/webm;codecs=opus';
                if (!MediaRecorder.isTypeSupported(mimeType)) {
                    mimeType = 'audio/webm';
                }

                log(`üî¥ Starting recording with ${mimeType}...`, 'info');

                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: mimeType,
                    audioBitsPerSecond: 128000
                });

                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                        log(`üìä Received audio chunk: ${event.data.size} bytes`, 'info');
                    }
                };

                mediaRecorder.onstop = async () => {
                    log('‚èπÔ∏è Recording stopped', 'info');
                    document.getElementById('recordingIndicator').style.display = 'none';

                    if (audioChunks.length === 0) {
                        log('‚ùå No audio data captured!', 'error');
                        showStatus('‚ùå Recording failed - no audio captured. Try speaking louder!', 'error');
                        return;
                    }

                    const audioBlob = new Blob(audioChunks, { type: mimeType });
                    lastRecordedBlob = audioBlob;  // Store for speech recognition test
                    log(`üì¶ Created audio blob: ${audioBlob.size} bytes`, 'success');

                    if (audioBlob.size < 1000) {
                        log('‚ö†Ô∏è Audio blob is very small - may not contain speech', 'warning');
                        showStatus('‚ö†Ô∏è Recording is very small. Try recording for at least 3 seconds while speaking continuously.', 'warning');
                    } else {
                        // Show speech test button for good recordings
                        document.getElementById('testSpeech').style.display = 'inline-block';
                        log('‚úÖ Recording looks good! Click "Test Speech Recognition" to test it.', 'success');
                    }

                    // Send to diagnostic endpoint
                    await diagnoseAudio(audioBlob);
                };

                mediaRecorder.start(100); // Collect data every 100ms
                log('‚úÖ Recording started! Speak now...', 'success');
                showStatus('üî¥ Recording... Speak clearly into your microphone!', 'info');

                document.getElementById('recordingIndicator').style.display = 'inline';
                document.getElementById('startRecording').disabled = true;
                document.getElementById('stopRecording').disabled = false;

            } catch (error) {
                log(`‚ùå Recording error: ${error.message}`, 'error');
                showStatus(`‚ùå Recording failed: ${error.message}`, 'error');
            }
        });

        // Stop recording
        document.getElementById('stopRecording').addEventListener('click', () => {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                document.getElementById('startRecording').disabled = false;
                document.getElementById('stopRecording').disabled = true;
            }
        });

        // Diagnose audio
        async function diagnoseAudio(audioBlob) {
            log('üîç Sending audio for diagnosis...', 'info');
            showStatus('üîç Analyzing audio quality...', 'info');

            try {
                const formData = new FormData();
                formData.append('audio_file', audioBlob, 'test-recording.webm');

                const response = await fetch(`${API_URL}/api/diagnose-audio`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    const diag = result.diagnosis;

                    log('=== DIAGNOSTIC RESULTS ===', 'info');
                    log(`File size: ${diag.file_size_bytes} bytes (${diag.file_size_kb} KB)`, 'info');
                    log(`Format: ${diag.audio_format}`, 'info');
                    log(`Has audio stream: ${diag.has_audio_stream}`, diag.has_audio_stream ? 'success' : 'error');
                    log(`Quality: ${diag.quality}`, 'info');
                    log(`Issue: ${diag.likely_issue}`, 'warning');

                    let statusMsg = `üìä Analysis Complete:\n`;
                    statusMsg += `Size: ${diag.file_size_kb} KB | Quality: ${diag.quality}\n`;
                    statusMsg += `Issue: ${diag.likely_issue}`;

                    if (diag.file_size_bytes < 5000) {
                        showStatus(statusMsg, 'warning');
                    } else {
                        showStatus(statusMsg, 'success');
                    }

                    log('=== RECOMMENDATIONS ===', 'info');
                    diag.recommendations.forEach(rec => {
                        log(rec, 'warning');
                    });

                    // Display results
                    let infoHTML = `<strong>üìä Diagnostic Results:</strong><br>`;
                    infoHTML += `File Size: ${diag.file_size_bytes} bytes (${diag.file_size_kb} KB)<br>`;
                    infoHTML += `Format: ${diag.audio_format}<br>`;
                    infoHTML += `Quality: ${diag.quality}<br>`;
                    infoHTML += `<br><strong>Issue:</strong> ${diag.likely_issue}<br>`;
                    infoHTML += `<br><strong>Recommendations:</strong><br>`;
                    diag.recommendations.forEach(rec => {
                        infoHTML += `${rec}<br>`;
                    });

                    document.getElementById('audioInfo').innerHTML = infoHTML;

                } else {
                    log(`‚ùå Diagnosis failed: ${result.error}`, 'error');
                    showStatus(`‚ùå Diagnosis failed: ${result.error}`, 'error');
                }

            } catch (error) {
                log(`‚ùå Failed to diagnose: ${error.message}`, 'error');
                showStatus(`‚ùå Failed to connect to server: ${error.message}`, 'error');
            }
        }

        // Test speech recognition
        document.getElementById('testSpeech').addEventListener('click', async () => {
            if (!lastRecordedBlob) {
                showStatus('‚ùå No recording available. Please record first!', 'error');
                return;
            }

            log('üéØ Testing speech recognition...', 'info');
            showStatus('üéØ Sending to speech recognition...', 'info');

            try {
                const formData = new FormData();
                formData.append('audio_file', lastRecordedBlob, 'recording.webm');
                formData.append('agent_id', 'support_agent');  // Use your agent ID

                const response = await fetch(`${API_URL}/api/speech-chat`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    log('‚úÖ Speech recognition SUCCESS!', 'success');
                    log(`Transcribed: "${result.transcribed_text}"`, 'success');
                    log(`Response: "${result.response_text}"`, 'info');

                    // Display results
                    document.getElementById('speechResult').style.display = 'block';
                    document.getElementById('speechText').innerHTML = `<strong>You said:</strong> "${result.transcribed_text}"`;
                    document.getElementById('responseText').innerHTML = `<strong>AI Response:</strong> ${result.response_text}`;

                    if (result.audio_url) {
                        const audioEl = document.getElementById('responseAudio');
                        audioEl.src = `${API_URL}${result.audio_url}`;
                        audioEl.style.display = 'block';
                        audioEl.play();
                        log('üîä Playing AI response audio...', 'success');
                    }

                    showStatus('‚úÖ Speech recognition successful! See results above.', 'success');

                } else {
                    log(`‚ùå Speech recognition failed: ${result.error}`, 'error');
                    showStatus(`‚ùå Speech recognition failed: ${result.error || 'Unknown error'}`, 'error');

                    // Show what was attempted
                    if (result.transcribed_text) {
                        log(`Transcribed (fallback): "${result.transcribed_text}"`, 'warning');
                    }
                }

            } catch (error) {
                log(`‚ùå Speech test error: ${error.message}`, 'error');
                showStatus(`‚ùå Failed to connect: ${error.message}`, 'error');
            }
        });

        // Initial message
        log('üé§ Microphone Test Tool Ready', 'info');
        log('Click "Test Microphone Access" to begin', 'info');
        showStatus('üëÜ Click "Test Microphone Access" to get started', 'info');
    </script>
</body>
</html>
